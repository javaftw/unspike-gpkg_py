# Unspike gpkg (Python stand-alone version)

**unspike** is a tool designed to remove 'spikes' from polygons in GeoPackage files by filtering out vertices that form angles sharper than a specified threshold. It works with both 2D and 3D geometries and supports both single Polygons and MultiPolygons.

### Before and After

![Before unspike](img/before.png)
![After unspike](img/after.png)

## Features

- Removes spike vertices from Polygons and MultiPolygons
- Supports both 2D and 3D geometries
- Preserves the original coordinate reference system (CRS)
- Handles invalid geometries by attempting to make them valid
- Provides verbose output option for detailed processing information
- Automatically generates output filename if not specified

## Requirements

- Python 3.6+
- Dependencies:
  - fiona
  - numpy
  - shapely
  - pyproj

You can install the required dependencies using pip:

```
pip install fiona numpy shapely pyproj
```

## Usage

To use the tool, run the script from the command line with the following arguments:

```
python unspike.py -i <input_file> [-o <output_file>] -a <minimum_angle> [-v]
```

Arguments:
- `-i`, `--input`: Path to the input GeoPackage file (required)
- `-o`, `--output`: Path to the output GeoPackage file (optional, will be auto-generated if not provided)
- `-a`, `--angle`: Minimum angle threshold in degrees (required)
- `-v`, `--verbose`: Enable verbose output (optional)

Example:
```
python unspike.py -i input.gpkg -o output.gpkg -a 4.5 -v
```

This command will process `input.gpkg`, remove spikes with angles less than 4.5 degrees, and save the result to `output.gpkg` with verbose output.

## How It Works

1. The script reads the input GeoPackage file using Fiona.
2. For each feature in the file:
   - It converts the geometry to a Shapely object.
   - It processes the geometry using the `filter_vertices` function, which removes vertices that form angles smaller than the specified threshold.
   - If the resulting geometry is valid and not empty, it's written to the output file.
3. The script maintains the original CRS and attempts to preserve the validity of the geometries.
4. If a polygon becomes invalid after processing, the script attempts to make it valid using Shapely's `make_valid` function.

## Output

The script generates a new GeoPackage file with the processed geometries. It also prints a summary of the processing, including:
- Number of features processed
- Number of features skipped (if any became empty or invalid)
- Total number of spikes removed

## Notes

- The script suppresses deprecation warnings from Fiona and PyProj to reduce clutter in the output.
- Geometries that become empty or invalid after processing are skipped and not included in the output file.
- The script uses numpy for efficient angle calculations.
- Portions of the code and documentation was generated by LLM AI under guidance of the author

## Flow Diagram

```mermaid
graph TD
    A[Start] --> B[Parse Command Line Arguments]
    B --> C[Open Input GeoPackage]
    C --> D[Create Output GeoPackage]
    D --> E[Process Features]
    E --> F{Is Feature Polygon?}
    F -->|Yes| G[Filter Polygon]
    F -->|No| H[Filter MultiPolygon]
    G --> I[Remove Spikes]
    H --> I
    I --> J{Is Filtered Geometry Valid?}
    J -->|Yes| K[Write to Output]
    J -->|No| L[Skip Feature]
    K --> M{More Features?}
    L --> M
    M -->|Yes| E
    M -->|No| N[Close GeoPackages]
    N --> O[Print Summary]
    O --> P[End]

    subgraph filter_polygon[Filter Polygon]
        G1[Get Coordinates] --> G2[Calculate Angles]
        G2 --> G3[Remove Vertices Below Threshold]
        G3 --> G4[Handle Start/End Point]
        G4 --> G5[Create New Polygon]
        G5 --> G6[Validate Polygon]
    end

    subgraph calculate_angle[Calculate Angle]
        CA1[Convert Points to Vectors] --> CA2[Calculate Dot Product]
        CA2 --> CA3[Calculate Vector Norms]
        CA3 --> CA4[Apply Dot Product Formula]
        CA4 --> CA5[Convert to Degrees]
    end
```